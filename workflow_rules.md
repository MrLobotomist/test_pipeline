# Правила командной работы и защиты веток

## 1. Защита ветки main

Ветка `main` является основной веткой проекта. Прямой push в неё запрещен. Все изменения поступают исключительно через Pull Request.

**Настройки Branch Protection Rules:**

| Правило | Значение |
|---------|----------|
| Require a pull request before merging | Включено |
| Require approvals | Минимум 1 |
| Require status checks to pass before merging | Включено (lint, test, security) |
| Require branches to be up to date before merging | Включено |
| Restrict who can push to matching branches | Только maintainers |
| Allow force pushes | Отключено |
| Allow deletions | Отключено |

---

## 2. Обязательность Pull Request

Каждое изменение оформляется как Pull Request со следующими требованиями:

1. Название PR кратко отражает суть изменений.
2. Описание содержит:
   - что было изменено и зачем;
   - как проверить корректность (инструкция для ревьюера);
   - ссылку на задачу (issue), если применимо.
3. PR привязан к соответствующей ветке вида `feature/описание` или `fix/описание`.

---

## 3. Обязательное ревью (минимум 1 approval)

Ни один Pull Request не может быть влит в main без одобрения хотя бы одного другого участника команды. Ревьюер проверяет:

- корректность логики;
- соответствие стилю кода;
- наличие тестов для новой функциональности;
- отсутствие секретов и небезопасных конструкций.

---

## 4. Required Status Checks

Слияние PR заблокировано до тех пор, пока все обязательные проверки CI не завершатся успешно:

| Проверка | Описание |
|----------|----------|
| `lint` | ruff check, ruff format --check, mypy |
| `test` | pytest с покрытием не ниже 80% |
| `security` | trufflehog, bandit, pip-audit |

Если хотя бы одна из этих проверок завершается с ошибкой, кнопка Merge становится недоступной.

---

## 5. Стратегия слияния: Rebase

Используется стратегия **Rebase and merge**. Это обеспечивает:

- линейную историю коммитов без merge-коммитов;
- простоту чтения `git log`;
- возможность использования `git bisect` для поиска регрессий.

В настройках репозитория отключены опции Merge commit и Squash merge.

---

## 6. CODEOWNERS

Файл `.github/CODEOWNERS` определяет, кто автоматически назначается ревьюером для изменений в определённых частях проекта.

Пример содержимого:

```
# Владельцы всего проекта
*                   @team-lead

# Конфигурация CI/CD
.github/            @devops-team
ci_config/          @devops-team

# Исходный код
src/                @backend-team

# Тесты
tests/              @qa-team
```

При создании PR, затрагивающего указанные пути, соответствующие владельцы автоматически добавляются в список ревьюеров.

---

## 7. Культура Blameless (безобвинительная культура)

### 7.1. Шаблон Post-mortem

При возникновении инцидента (падение production, критическая уязвимость, длительная недоступность CI) составляется отчёт по следующему шаблону:

```
## Post-mortem: [Краткое название инцидента]

**Дата:** ДД.ММ.ГГГГ
**Автор отчёта:** Имя Фамилия
**Уровень критичности:** Низкий / Средний / Высокий / Критический

### Что произошло
Краткое описание инцидента в 2-3 предложениях.

### Влияние
- На каких пользователей/сервисы повлияло.
- Длительность воздействия.

### Хронология
| Время | Событие |
|-------|---------|
| HH:MM | Обнаружение проблемы |
| HH:MM | Начало расследования |
| HH:MM | Применение исправления |
| HH:MM | Подтверждение восстановления |

### Корневая причина
Подробное описание причины инцидента.

### Действия по предотвращению
| Действие | Ответственный | Срок |
|----------|---------------|------|
| ...      | ...           | ...  |
```

### 7.2. Правила коммуникации при падении пайплайна

1. **Сообщение формулируется как:** «В задании lint на PR #42 обнаружена ошибка типизации в модуле auth.py» — а не «Кто сломал lint?».
2. При обнаружении красного CI автор PR получает автоматическое уведомление и самостоятельно берёт исправление в работу.
3. Если автор PR недоступен, любой участник команды может предложить исправление через отдельный коммит.
4. Результаты разбора инцидентов обсуждаются на еженедельной встрече команды в формате «что произошло и как предотвратить повторение».

### 7.3. Онбординг нового участника

#### Как открыть Pull Request

1. Создать ветку от main: `git checkout -b feature/описание`.
2. Внести изменения и зафиксировать их: `git add . && git commit -m "описание"`.
3. Отправить ветку в удалённый репозиторий: `git push -u origin feature/описание`.
4. Перейти в раздел Pull Requests на GitHub и нажать New Pull Request.
5. Заполнить название и описание, назначить ревьюера.
6. Дождаться прохождения всех проверок CI и одобрения ревьюера.

#### Как исправить красный CI

1. Открыть вкладку Checks в Pull Request.
2. Найти задание, завершившееся с ошибкой (отмечено красным крестиком).
3. Нажать Details и изучить лог выполнения.
4. Определить строку с ошибкой (обычно выделена в логе).
5. Исправить код локально, зафиксировать и отправить изменения.
6. Дождаться повторного запуска проверок.

#### Как читать логи CI

- Каждое задание (lint, test, security) отображается отдельным блоком.
- Развернуть блок можно нажатием на его название.
- Ошибки обычно находятся в конце лога и выделены красным цветом.
- Формат ошибки линтера: `файл:строка:столбец: код_правила описание`.
- Формат ошибки теста: `FAILED tests/test_file.py::test_name - AssertionError`.
- Формат ошибки безопасности: `[severity] описание найденной проблемы`.
