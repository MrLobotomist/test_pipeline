# Архитектура CI/CD-пайплайна

## Проект и стек

- **Язык:** Python 3.11+
- **Фреймворк тестирования:** pytest
- **Линтер и форматирование:** ruff
- **Статическая типизация:** mypy
- **Анализ безопасности кода:** bandit
- **Поиск секретов:** trufflehog
- **Сканирование зависимостей:** pip-audit
- **CI-платформа:** GitHub Actions

---

## Этапы пайплайна

| Этап | Цель | Инструменты | Условия провала |
|------|------|-------------|-----------------|
| 1. Статический анализ | Обеспечить единый стиль кода, выявить синтаксические и типовые ошибки до запуска тестов | `ruff check`, `ruff format --check`, `mypy --strict` | Любое предупреждение ruff или ошибка типизации mypy приводят к провалу задания |
| 2. Модульные тесты | Убедиться в корректности отдельных функций и модулей; контролировать покрытие кода | `pytest --cov --cov-fail-under=80` | Падение хотя бы одного теста или покрытие ниже 80% |
| 3. Интеграционные тесты | Проверить взаимодействие компонентов в окружении, приближенном к рабочему | `pytest -m integration`, Docker Compose для внешних сервисов | Падение любого интеграционного теста. Этап является необязательным для PR, обязательным для ветки main |
| 4. Сканирование безопасности | Обнаружить утечки секретов, известные уязвимости в зависимостях и небезопасные конструкции в коде | `trufflehog git`, `pip-audit`, `bandit -r src/` | Обнаружение секрета в коммитах, наличие уязвимости с уровнем HIGH или CRITICAL, ошибки bandit с уровнем HIGH |

---

## Визуальная схема пайплайна

```
push / pull_request
        |
        v
+---------------------+
|   Установка Python   |
|   + кэш pip          |
+---------+-----------+
          |
     +----+----+
     v         v
+--------+ +--------------+
|  Lint  | |  Security    |
|  ruff  | |  trufflehog  |
|  mypy  | |  bandit      |
+---+----+ |  pip-audit   |
    |      +------+-------+
    v             v
+---------------------+
|  Модульные тесты    |
|  pytest --cov       |
+---------+-----------+
          | (только main)
          v
+-------------------------+
| Интеграционные тесты    |
| pytest -m integration   |
+-------------------------+
```

Этапы Lint и Security выполняются параллельно. Модульные тесты запускаются после их успешного завершения. Интеграционные тесты запускаются только при слиянии в main.

---

## Стратегия быстрой обратной связи

### Целевое время основных проверок: менее 2 минут

Для достижения этой цели применяются следующие подходы.

### 1. Кэширование зависимостей

Используется встроенное кэширование GitHub Actions для каталога pip. Ключ кэша формируется на основе хэша файла `requirements.txt`. При совпадении ключа установка зависимостей пропускается, что экономит 30-60 секунд на каждом запуске.

```yaml
- uses: actions/cache@v4
  with:
    path: ~/.cache/pip
    key: pip-${{ hashFiles('requirements.txt') }}
```

### 2. Параллелизм заданий

Этапы линтинга и сканирования безопасности не зависят друг от друга и запускаются одновременно. Это сокращает суммарное время пайплайна, поскольку наиболее длительный из двух этапов определяет время ожидания, а не их сумма.

### 3. Разделение на быстрые и длительные проверки

| Категория | Проверки | Когда запускается |
|-----------|----------|-------------------|
| Быстрые (required) | ruff, mypy, pytest (модульные), trufflehog, bandit | Каждый PR и каждый push |
| Длительные (дополнительные) | Интеграционные тесты с Docker, полный pip-audit | Слияние в main, ночной запуск по расписанию |

### 4. Принцип fail-fast

Если один из параллельных этапов завершается с ошибкой, оставшиеся этапы продолжают выполнение для полноты отчета, однако результат пайплайна считается неуспешным. Разработчик получает уведомление сразу после первого сбоя.
